<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Game Awards Voting</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<style>
/* * Material 3 Dark Theme Colors (using a primary blue/cyan)
 * This uses a dark-mode palette which M3 heavily promotes.
 */
:root{
  /* Surface and Background */
  --m3-surface:#1C1B1F; /* Primary surface color */
  --m3-background:#1C1B1F; /* Page background, slightly darker is sometimes preferred */
  --m3-surface-container-high:#2C2B2F; /* Card/Container background */
  --m3-surface-container:#211F26; /* Less prominent surface */
  /* Primary Color (e.g., Cyan/Blue) */
  --m3-primary:#68D8FF; /* Primary light/vibrant color for dark mode */
  --m3-on-primary:#003544; /* Text on primary */
  --m3-primary-container:#004D63; /* Primary accent container */
  --m3-on-primary-container:#B8EAFF; /* Text on primary container */
  /* Secondary Color (for secondary elements like muted text or icons) */
  --m3-secondary:#B8C6D8;
  --m3-on-secondary:#243140;
  /* Text */
  --m3-on-surface:#E6E1E5; /* High-emphasis text */
  --m3-on-surface-variant:#C7C5D0; /* Medium-emphasis text */
  /* Error/Danger */
  --m3-error:#F2B8B5;
  --m3-on-error:#601410;
  
  /* Golden Shine Colors */
  --golden-color: #FFD700;
  --golden-shadow: #FFBF00;
}
/* Reset and Base Styles */
*{box-sizing:border-box;}
body{
  font-family:'Roboto', 'Inter', Arial, sans-serif; 
  background:var(--m3-background); 
  margin:0; 
  color:var(--m3-on-surface);
}
/* Header/App Bar (Material 3 Top App Bar style) */
header{
  background:var(--m3-surface-container-high); 
  color:var(--m3-on-surface); 
  padding:14px 18px; 
  display:flex; 
  justify-content:space-between; 
  align-items:center;
  border-bottom:1px solid rgba(255, 255, 255, 0.08);
}
header h1{margin:0;font-size:20px; font-weight:500;}

/* Tabs (Material 3 Segmented Button/Pills style) */
.tabs{
  display:flex;
  gap:8px;
  background:var(--m3-surface-container);
  padding:4px;
  border-radius:20px; /* Highly rounded corners */
}
.tab{
  background:transparent; 
  border:0; 
  color:var(--m3-on-surface-variant); 
  padding:8px 14px; 
  border-radius:16px; /* Pill shape */
  cursor:pointer; 
  font-weight:500;
  transition:background 0.2s, color 0.2s;
  font-size:14px;
}
.tab.active{
  background:var(--m3-primary-container);
  color:var(--m3-on-primary-container);
  box-shadow:0 1px 3px rgba(0,0,0,0.15); /* Subtle elevation */
}
.tab:hover:not(.active){
  background:var(--m3-surface-container-high);
}

/* Main Content Area */
main{max-width:940px;margin:24px auto;padding:0 16px}

/* Card (Material 3 Card style) */
.card{
  background:var(--m3-surface-container-high); 
  border-radius:16px; /* More rounded */
  padding:24px; 
  box-shadow:0 4px 12px rgba(0,0,0,0.3); /* Higher elevation shadow */
  margin-bottom:20px; 
  border:none; /* M3 generally uses shadow for separation, not border */
}

/* Typography */
h2,h3{margin:0 0 16px 0;color:var(--m3-on-surface); font-weight:400;}
h2{font-size:24px;}
h3{font-size:18px;}
label{display:block;font-size:14px;color:var(--m3-on-surface-variant);margin-bottom:6px;}

/* Inputs (Material 3 Outlined/Filled style) */
input[type=text], select, input[type=password]{
  width:100%; 
  padding:12px 16px; /* Taller padding */
  border-radius:8px; 
  border:1px solid var(--m3-secondary); 
  background:var(--m3-surface); 
  color:var(--m3-on-surface);
  font-size:16px;
  transition:border-color 0.2s, box-shadow 0.2s;
}
input[type=text]:focus, select:focus, input[type=password]:focus{
  border-color:var(--m3-primary);
  box-shadow:0 0 0 1px var(--m3-primary);
  outline:none;
}
select{
  -webkit-appearance:none;
  -moz-appearance:none;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='24' viewBox='0 0 24 24' width='24'%3E%3Cpath fill='%23C7C5D0' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 12px top 50%;
  padding-right:36px;
}

/* Layout */
.row{display:flex;gap:16px;flex-wrap:wrap;}
.col{flex:1;min-width:180px;}

/* Checkbox/Input Row */
.input-row { display: flex; align-items: center; margin-bottom: 12px; }
.input-row label { margin-bottom: 0; margin-left: 8px; font-size: 16px; color: var(--m3-on-surface); }
input[type=checkbox] { width: auto; height: 18px; margin: 0; }

/* Buttons (Material 3 Elevated/Filled Button style) */
button{
  background:var(--m3-primary); 
  color:var(--m3-on-primary); 
  border:0; 
  padding:10px 16px; 
  border-radius:20px; /* Highly rounded corners */
  cursor:pointer; 
  font-weight:500;
  font-size:15px;
  transition:background 0.2s, box-shadow 0.2s, opacity 0.2s;
  box-shadow:0 2px 4px rgba(0,0,0,0.2);
}
button:hover{
  background:color-mix(in srgb, var(--m3-primary), white 10%); /* Subtle hover color change */
  box-shadow:0 3px 6px rgba(0,0,0,0.3);
}
button.secondary{
  background:var(--m3-surface-container);
  color:var(--m3-on-surface);
}
button.secondary:hover{
  background:color-mix(in srgb, var(--m3-surface-container), white 5%);
}

/* Button variants */
.small{padding:8px 12px;border-radius:16px;font-size:13px;}
.muted{color:var(--m3-on-surface-variant);font-size:14px;}
b{color:var(--m3-primary);} /* Accent for bold text */

/* Category Box/Container (similar to a card variant) */
.category-box{
  border-radius:12px; 
  padding:16px; 
  background:var(--m3-surface-container); 
  border:none; 
  margin-bottom:12px;
  position: relative; /* For shine effect */
  overflow: hidden; /* To contain the shine */
  transition: box-shadow 0.3s;
}

/* --- GOLDEN SHINE EFFECT --- */
@keyframes glow-pulse {
    0% { box-shadow: 0 0 8px rgba(255, 191, 0, 0.4); }
    50% { box-shadow: 0 0 16px rgba(255, 191, 0, 0.7), 0 0 24px rgba(255, 191, 0, 0.3); }
    100% { box-shadow: 0 0 8px rgba(255, 191, 0, 0.4); }
}

@keyframes shine-flow {
  0% { transform: skewX(-25deg) translateX(-150%); }
  100% { transform: skewX(-25deg) translateX(600%); } 
}

.golden-shine {
    /* Subtle background texture for gold look */
    background: linear-gradient(145deg, var(--m3-surface-container) 70%, var(--golden-color) 100%);
    border: 2px solid var(--golden-color);
    animation: glow-pulse 3s infinite alternate;
}

.golden-shine::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 20%;
    height: 100%;
    background: rgba(255, 255, 255, 0.4);
    pointer-events: none;
    animation: shine-flow 4s infinite;
}
.golden-shine strong {
    color: var(--golden-color); /* Highlight category title */
    text-shadow: 0 0 5px rgba(255, 191, 0, 0.5);
}
/* --- END GOLDEN SHINE EFFECT --- */

/* New style for the results category grid */
.category-grid{
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 20px;
}
.category-grid-item{
    background: var(--m3-surface-container);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    position: relative; /* To correctly clip the absolute ::after element */
    overflow: hidden; /* To hide the shine outside the box */
}
/* Apply golden shine to result grid items too */
.category-grid-item.golden-shine {
    /* Subtle background texture for gold look */
    background: linear-gradient(145deg, var(--m3-surface-container) 70%, var(--golden-color) 100%);
    border: 2px solid var(--golden-color);
    animation: glow-pulse 3s infinite alternate;
}

.category-grid-item.golden-shine strong {
    color: var(--golden-color);
    text-shadow: 0 0 5px rgba(255, 191, 0, 0.5);
}

.category-grid-item:hover{
    background: var(--m3-surface-container-high);
    box-shadow: 0 3px 6px rgba(0,0,0,0.3);
}
.category-grid-item strong{
    display: block;
    font-size: 16px;
    font-weight: 500;
    color: var(--m3-on-surface);
}

.list{margin:0;padding:0;list-style:none;}
.list li{
  padding:10px 6px; 
  border-bottom:1px solid rgba(255, 255, 255, 0.08); 
  display:flex; 
  justify-content:space-between; 
  align-items:center;
}
.danger{
  background:var(--m3-error);
  color:var(--m3-on-error);
}
.danger:hover{
  background:color-mix(in srgb, var(--m3-error), black 10%);
}
.nominees{margin-top:12px;}
.center{text-align:center;}
.spaced{margin-top:16px;}

/* Chip (Material 3 Input/Assist Chip style) */
.chip{
  display:inline-flex;
  align-items:center;
  padding:8px 12px;
  border-radius:8px;
  background:var(--m3-surface-container-high);
  border:1px solid var(--m3-secondary);
  margin-right:8px;
  margin-bottom:8px;
  color:var(--m3-on-surface);
  font-size:14px;
}
.chip button{
  background:transparent;
  border:none;
  color:var(--m3-on-surface-variant);
  margin-left:6px;
  cursor:pointer;
  padding:0;
  line-height:1;
  font-weight:400;
  font-size:18px;
  box-shadow:none;
}
.chip button:hover{
  color:var(--m3-primary);
  background:transparent;
  box-shadow:none;
}

/* Notice (Material 3 Inline Message/Attention style) */
.notice{
  background:var(--m3-primary-container); 
  border:none; 
  padding:12px 16px; 
  border-radius:8px; 
  margin-bottom:12px; 
  color:var(--m3-on-primary-container);
}
footer{
  max-width:940px; 
  margin:20px auto 40px; 
  padding:0 16px; 
  color:var(--m3-on-surface-variant); 
  font-size:13px; 
  text-align:center;
}
@media (max-width:640px){.row{flex-direction:column}.tabs{gap:4px}}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD7938E45kuERRFVTKV5djhBGoqeDN29XY",
  authDomain: "game-awards-voting-d2539.firebaseapp.com",
  databaseURL: "https://game-awards-voting-d2539-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "game-awards-voting-d2539",
  storageBucket: "game-awards-voting-d2539.firebasestorage.app",
  messagingSenderId: "138398205198",
  appId: "1:138398205198:web:8ca44d0fee61f97ab7035f",
  measurementId: "G-DMH48E4BZN"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ADMIN_PASS = 'admin123';

const appEl = document.getElementById('app');
const tabsEl = document.getElementById('top-tabs');
tabsEl.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button.tab'); if(!btn) return;
  Array.from(tabsEl.children).forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  showPage(btn.dataset.tab);
});

function escapeHtml(s){ if(!s&&s!==0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

async function loadCategories(){ const snap=await get(ref(db,'categories')); return snap.val()||[]; }
async function saveCategories(cats){ await set(ref(db,'categories'), cats); }
async function loadVotes(){ const snap=await get(ref(db,'votes')); return snap.val()||{}; }
async function loadUserVotes(name){ const snap=await get(ref(db,'votes/'+name)); return snap.val()||{}; } 
async function saveVote(name,vote){ await set(ref(db,'votes/'+name), vote); }
async function removeUserVotes(user){ await remove(ref(db,'votes/'+user)); }
async function clearAllVotes(){ await remove(ref(db,'votes')); }

let resultsNavState = null; 

async function showPage(page){
  appEl.innerHTML='';
  if(page==='vote') await renderVotePage();
  else if(page==='results') await renderResultsPage();
  else if(page==='categories') await renderCategoryListPage();
  else if(page==='admin') await renderAdminPage();
}

// ==================== VOTE PAGE ====================
async function renderVotePage(){
  const categories = await loadCategories();
  const card = document.createElement('div'); card.className='card';
  card.innerHTML=`
    <h2>Cast Your Votes</h2>
    <div class="muted spaced">Enter your name. If you have previously voted, your selections will automatically load.</div>
    <div class="row spaced">
      <div class="col"><label>Your name</label><input id="voter-name" type="text" placeholder="Full name or nickname"></div>
    </div>
    <div id="vote-areas"></div>
    <div class="spaced center"><button id="submit-votes">Submit Votes</button></div>
  `;
  appEl.appendChild(card);
  const voteAreas = card.querySelector('#vote-areas');
  const nameInput = card.querySelector('#voter-name');
  const submitButton = card.querySelector('#submit-votes'); // Get button reference

  if(categories.length===0){ 
    voteAreas.innerHTML='<div class="notice">No categories yet.</div>'; 
    return; 
  }

  const renderVoteFields = (existingVotes = {}) => {
    voteAreas.innerHTML = ''; 
    categories.forEach(cat => {
      const wrap = document.createElement('div'); 
      wrap.className = 'category-box';
      
      const categoryName = cat.name;
      const userCategoryVote = existingVotes[categoryName] || {};

      // APPLY GOLDEN SHINE CLASS
      if(cat.isSpecial) {
        wrap.classList.add('golden-shine');
      }
      
      wrap.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>${escapeHtml(categoryName)}</strong></div>
      <div class="nominees">
        <label><b>Who will win?</b></label><select data-cat="${escapeHtml(categoryName)}" data-type="willWin"></select>
        <label style="margin-top:16px"><b>Who do you want to win?</b></label><select data-cat="${escapeHtml(categoryName)}" data-type="wantWin"></select>
      </div>`;
      voteAreas.appendChild(wrap);

      wrap.querySelectorAll('select').forEach(s => {
        const type = s.dataset.type;
        const defaultValue = userCategoryVote[type] || '';

        const def = document.createElement('option'); 
        def.value = ''; 
        def.textContent = 'â€” Select â€”'; 
        s.appendChild(def);
        
        (cat.nominees||[]).forEach(n => { 
          const opt = document.createElement('option'); 
          opt.value = n; 
          opt.textContent = n; 
          if (n === defaultValue) {
              opt.selected = true;
          }
          s.appendChild(opt); 
        });
      });
    });
  };

  renderVoteFields(); 
  
  nameInput.addEventListener('input', async (e) => {
    const name = e.target.value.trim();
    if (name) {
      const existingVotes = await loadUserVotes(name);
      if (Object.keys(existingVotes).length > 0) {
        renderVoteFields(existingVotes);
      }
    } else {
        renderVoteFields({});
    }
  });

  // FIX: Attach event listener to the submit button reference
  submitButton.addEventListener('click', async ()=>{
    const name = nameInput.value.trim();
    if(!name){ alert('Enter your name'); return; }
    
    const selections={};
    let totalVotes = 0;

    card.querySelectorAll('select').forEach(s=>{
      const c=s.dataset.cat, t=s.dataset.type;
      
      // Only include a selection if a value was chosen (it's not the default empty string)
      if (s.value) {
        if(!selections[c]) selections[c]={};
        selections[c][t]=s.value;
        totalVotes++;
      } else {
        // If a category was previously voted on, but the user changed it to empty, 
        // we should remove that specific pick. If both picks for a category are empty, 
        // the category itself won't be saved/updated for the user.
        if (selections[c] && selections[c][t]) {
             delete selections[c][t];
             if (Object.keys(selections[c]).length === 0) {
                 delete selections[c];
             }
        }
      }
    });

    if (totalVotes === 0) {
      alert('Please select at least one nominee to submit.');
      return;
    }

    await saveVote(name,selections);
    alert(`Votes saved/updated online for ${name}. Total ${totalVotes} picks submitted.`);
  });
}

// ==================== RESULTS PAGE ====================
async function renderResultsPage(){
  const auth = localStorage.getItem('ga_admin_auth') === '1';
  appEl.innerHTML='';
  const card = document.createElement('div'); card.className='card';
  appEl.appendChild(card);

  if(!auth){
    card.innerHTML = `
      <h2>Results Locked ðŸ”’</h2>
      <div class="notice">This page is restricted. Please log in using the **Admin** tab to view the results.</div>
    `;
    return;
  }
  
  const categories = await loadCategories();
  card.innerHTML=`<h2>Check Winner Picks</h2><div class="muted">Select a category to enter the official winner and see which users successfully picked it.</div>`;
  
  if(categories.length===0){ 
    card.innerHTML+='<div class="muted spaced">No categories have been defined yet.</div>'; 
    return; 
  }

  const grid = document.createElement('div');
  grid.className='category-grid';
  categories.forEach((cat, idx)=>{
    const item = document.createElement('div');
    item.className='category-grid-item';
    
    // APPLY GOLDEN SHINE CLASS HERE TOO
    if(cat.isSpecial) {
        item.classList.add('golden-shine');
    }

    item.dataset.idx = idx;
    item.innerHTML = `<strong>${escapeHtml(cat.name)}</strong>`;
    item.addEventListener('click', () => renderResultsCategoryDetail(idx));
    grid.appendChild(item);
  });
  card.appendChild(grid);
}

// STEP 2: Show Nominees and Winner Input 
async function renderResultsCategoryDetail(idx){
  if(localStorage.getItem('ga_admin_auth') !== '1') {
      await renderResultsPage();
      return;
  }
  
  resultsNavState = 'results:category'; 
  const categories = await loadCategories();
  const cat = categories[idx];
  appEl.innerHTML='';
  
  const card = document.createElement('div'); card.className='card';
  card.innerHTML=`
    <button class="small secondary" id="back-to-results"><span class="material-symbols-outlined" style="font-size:18px;vertical-align:middle;margin-right:4px;">arrow_back</span>Back to Categories</button>
    <h2>${escapeHtml(cat.name)}</h2>
    
    <label><b>Select the Official Winner:</b></label>
    <select id="winner-select"></select>

    <div class="spaced center">
        <button id="check-winner-btn">Check Winning Picks</button>
    </div>

    <div class="spaced"><strong>Nominees:</strong></div>
    <div id="nom-list"></div>
    <div id="pick-results" class="spaced"></div>
  `;
  appEl.appendChild(card);

  const nomList = card.querySelector('#nom-list');
  (cat.nominees||[]).forEach(n=>{
    const span = document.createElement('span'); 
    span.className='chip'; 
    span.textContent=n; 
    nomList.appendChild(span); 
  });

  const winnerSelect = card.querySelector('#winner-select');
  const def=document.createElement('option'); def.value=''; def.textContent='â€” Select Winner â€”'; winnerSelect.appendChild(def);
  (cat.nominees||[]).forEach(n=>{ 
    const opt=document.createElement('option'); 
    opt.value=n; 
    opt.textContent=n; 
    winnerSelect.appendChild(opt); 
  });

  card.querySelector('#back-to-results').addEventListener('click', () => renderResultsPage());
  card.querySelector('#check-winner-btn').addEventListener('click', () => checkWinnerPicks(cat.name, winnerSelect.value));
}


// STEP 3: Analyze Votes and Display Winners
async function checkWinnerPicks(categoryName, winnerNominee){
    const pickResults = document.getElementById('pick-results');
    pickResults.innerHTML = '';
    
    if (!winnerNominee) {
        pickResults.innerHTML = '<div class="notice">Please select an official winner first.</div>';
        return;
    }

    const votes = await loadVotes();
    const winningUsers = [];
    const losingUsers = [];

    for (const [user, userVotes] of Object.entries(votes)) {
        if (userVotes[categoryName]) {
            // Check both 'willWin' and 'wantWin' picks
            if (userVotes[categoryName].willWin === winnerNominee || userVotes[categoryName].wantWin === winnerNominee) {
                winningUsers.push(user);
            } else {
                losingUsers.push(user);
            }
        }
    }

    let resultsHtml = `<h3>Results for: ${escapeHtml(winnerNominee)}</h3>`;

    if (winningUsers.length > 0) {
        resultsHtml += `
            <div class="category-box" style="background: var(--m3-primary-container);">
                <strong>ðŸŽ‰ Users Who Picked the Winner (${winningUsers.length}):</strong>
                <div style="margin-top: 8px;">${winningUsers.map(u => `<span class="chip" style="background:var(--m3-primary); color:var(--m3-on-primary)">${escapeHtml(u)}</span>`).join('')}</div>
            </div>
        `;
    } else {
        resultsHtml += '<div class="notice">No users picked this winner.</div>';
    }

    if (losingUsers.length > 0) {
         resultsHtml += `
            <div class="category-box" style="background: var(--m3-surface-container);">
                <strong>ðŸ˜¢ Other Users Who Voted:</strong>
                <div style="margin-top: 8px;">${losingUsers.map(u => `<span class="chip">${escapeHtml(u)}</span>`).join('')}</div>
            </div>
        `;
    }


    pickResults.innerHTML = resultsHtml;
}

// ==================== CATEGORIES PAGE ====================
async function renderCategoryListPage(){
  const categories = await loadCategories();
  const card = document.createElement('div'); card.className='card'; 
  card.innerHTML='<h2>Categories & Nominees</h2><div class="muted">Check the games in each category. Voting results are hidden until the Admin logs in.</div>'; 
  appEl.appendChild(card);
  
  if(categories.length===0){ 
    card.innerHTML+='<div class="muted spaced">No categories have been defined yet.</div>'; 
    return; 
  }

  categories.forEach((cat)=>{
    const div = document.createElement('div'); 
    div.className='category-box';
    
    // APPLY GOLDEN SHINE CLASS
    if(cat.isSpecial) {
        div.classList.add('golden-shine');
    }

    div.innerHTML=`<strong>${escapeHtml(cat.name)}</strong>`;
    
    const chipsDiv=document.createElement('div'); 
    chipsDiv.className='nominees';
    (cat.nominees||[]).forEach(n=>{ 
      const span=document.createElement('span'); 
      span.className='chip'; 
      span.textContent=n; 
      chipsDiv.appendChild(span); 
    });
    
    div.appendChild(chipsDiv); 
    card.appendChild(div);
  });
}

// ==================== ADMIN PAGE ====================
async function renderAdminPage(){
  const card = document.createElement('div'); card.className='card'; card.innerHTML='<h2>Admin Panel</h2><div id="admin-root"></div>'; appEl.appendChild(card);
  const root = card.querySelector('#admin-root');
  const auth = localStorage.getItem('ga_admin_auth')==='1';
  if(!auth){
    root.innerHTML='<div class="muted spaced">Enter admin password:</div><div class="row"><div class="col"><input id="admin-pass" type="password"></div><div><button id="admin-login">Login</button></div></div>';
    root.querySelector('#admin-login').addEventListener('click', ()=>{
      const val=root.querySelector('#admin-pass').value;
      if(val===ADMIN_PASS){ 
        localStorage.setItem('ga_admin_auth','1'); 
        alert('Admin login successful. Results page is now unlocked.');
        renderAdminPage(); 
      }
      else alert('Incorrect password');
    });
    return;
  }

  root.innerHTML=`
  <div class="row">
    <div class="col">
      <h3>Add Category</h3>
      <label>Category Name</label>
      <input id="new-cat-name" type="text">
      <div class="input-row">
        <input type="checkbox" id="is-special-cat">
        <label for="is-special-cat">Mark as Special Category (Golden Shine)</label>
      </div>
      <div class="spaced"><button id="add-cat">Add Category</button></div>
    </div>
    <div class="col">
      <h3>Manage Categories</h3>
      <label>Select category</label>
      <select id="manage-cat-select"></select>
      <div class="spaced" id="manage-cat-area"></div>
    </div>
  </div>
  <div class="row spaced">
    <div class="col">
      <h3>Votes Management</h3>
      <label>Delete user votes</label>
      <select id="delete-user-select"></select>
      <div class="spaced"><button id="delete-user-btn" class="small danger">Delete Votes</button></div>
      <div class="spaced"><label>Clear all votes</label><button id="clear-all-btn" class="danger small">Clear All</button></div>
    </div>
    <div class="col">
      <h3>Admin Logout</h3>
      <button id="logout-btn" class="secondary">Logout Admin</button>
      <div class="muted" style="margin-top: 8px;">Logging out will re-lock the Results page.</div>
    </div>
  </div>
  `;

  const adminUI = root;
  async function refreshManageSelect(){
    const sel = adminUI.querySelector('#manage-cat-select');
    const cats = await loadCategories();
    const oldVal = sel.value;
    sel.innerHTML='<option value="">Select category</option>';
    cats.forEach((c,i)=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=c.name; sel.appendChild(opt); });
    sel.value=oldVal; renderManageArea(sel.value);
  }

  async function renderManageArea(idx){
    const area = adminUI.querySelector('#manage-cat-area'); if(!idx && idx !== 0) { area.innerHTML=''; return; }
    idx = parseInt(idx);
    const cats = await loadCategories(); 
    if (idx < 0 || idx >= cats.length) { area.innerHTML = ''; return; }
    const cat = cats[idx];

    area.innerHTML=`
      <label>Add nominee (separate multiple entries with a **/**)</label>
      <div class="row"><div class="col"><input id="new-nom" placeholder="Nominee name or list (e.g., Game A / Game B)"></div><div><button id="add-nom" class="small">Add</button></div></div>
      <div class="spaced"><strong>Nominees</strong></div>
      <div id="nom-list"></div>
      <div class="spaced">
        <div class="input-row">
            <input type="checkbox" id="edit-is-special-cat" ${cat.isSpecial ? 'checked' : ''}>
            <label for="edit-is-special-cat">Mark as Special Category</label>
        </div>
      </div>
      <div class="spaced"><button id="delete-cat" class="danger">Delete Category & Votes</button></div>
    `;
    
    // Add event listener for editing special status
    area.querySelector('#edit-is-special-cat').addEventListener('change', async (e) => {
        cat.isSpecial = e.target.checked;
        const cats2 = await loadCategories();
        cats2[idx] = cat;
        await saveCategories(cats2);
    });
    
    const nomList = area.querySelector('#nom-list');
    (cat.nominees||[]).forEach((n,i)=>{
      const span = document.createElement('span'); span.className='chip'; span.textContent=n;
      const btn = document.createElement('button'); btn.textContent='Ã—'; 
      btn.addEventListener('click', async ()=>{
        cat.nominees.splice(i,1); 
        const cats2=await loadCategories(); 
        cats2[idx]=cat; 
        await saveCategories(cats2); 
        renderManageArea(idx);
      });
      span.appendChild(btn); nomList.appendChild(span);
    });

    area.querySelector('#add-nom').addEventListener('click', async ()=>{
      const inputVal = area.querySelector('#new-nom').value.trim(); 
      if(!inputVal) return;
      
      let newNominees = [];
      
      if (inputVal.includes('/')) {
        newNominees = inputVal.split('/').map(n => n.trim()).filter(n => n.length > 0);
      } else {
        newNominees = [inputVal];
      }

      cat.nominees = cat.nominees||[]; 
      cat.nominees.push(...newNominees);
      
      const cats2 = await loadCategories(); 
      cats2[idx]=cat; 
      await saveCategories(cats2); 
      
      area.querySelector('#new-nom').value = '';
      renderManageArea(idx);
    });

    area.querySelector('#delete-cat').addEventListener('click', async ()=>{
      if(!confirm('Delete category and votes?')) return;
      const cats2 = await loadCategories(); const catName = cats2[idx].name; cats2.splice(idx,1); await saveCategories(cats2);
      const votes = await loadVotes(); for(const u in votes){ if(votes[u]&&votes[u][catName]) delete votes[u][catName]; await set(ref(db,'votes'),votes);}
      alert('Deleted'); refreshManageSelect();
    });
  }

  adminUI.querySelector('#manage-cat-select').addEventListener('change', ()=>renderManageArea(adminUI.querySelector('#manage-cat-select').value));
  adminUI.querySelector('#add-cat').addEventListener('click', async ()=>{
    const val = adminUI.querySelector('#new-cat-name').value.trim(); 
    const isSpecial = adminUI.querySelector('#is-special-cat').checked; // Get checkbox value
    
    if(!val) return;
    const cats = await loadCategories(); 
    // ADD isSpecial PROPERTY
    cats.push({name:val, nominees:[], isSpecial: isSpecial}); 
    await saveCategories(cats);
    
    adminUI.querySelector('#new-cat-name').value=''; 
    adminUI.querySelector('#is-special-cat').checked = false; // Reset checkbox
    refreshManageSelect();
  });

  // Votes deletion
  async function refreshDeleteUserSelect(){
    const sel=adminUI.querySelector('#delete-user-select'); sel.innerHTML='<option value="">Select user</option>';
    const votes = await loadVotes(); Object.keys(votes).forEach(u=>{ const opt=document.createElement('option'); opt.value=u; opt.textContent=u; sel.appendChild(opt); });
  }
  refreshDeleteUserSelect();
  adminUI.querySelector('#delete-user-btn').addEventListener('click', async ()=>{
    const sel = adminUI.querySelector('#delete-user-select'); if(!sel.value) return; if(!confirm('Delete votes for '+sel.value+'?')) return;
    await removeUserVotes(sel.value); alert('Deleted'); refreshDeleteUserSelect();
  });
  adminUI.querySelector('#clear-all-btn').addEventListener('click', async ()=>{
    if(!confirm('Delete ALL votes?')) return; await clearAllVotes(); alert('Deleted all votes'); refreshDeleteUserSelect();
  });
  adminUI.querySelector('#logout-btn').addEventListener('click', ()=>{ 
    localStorage.removeItem('ga_admin_auth'); 
    renderAdminPage(); 
  });

  refreshManageSelect();
  refreshDeleteUserSelect();
}

showPage('vote');
</script>
</head>
<body>
<header>
  <h1>Game Awards Voting</h1>
  <div class="tabs" id="top-tabs">
    <button class="tab active" data-tab="vote">Vote</button>
    <button class="tab" data-tab="results">Results</button>
    <button class="tab" data-tab="categories">Categories</button>
    <button class="tab" data-tab="admin">Admin</button>
  </div>
</header>
<main id="app"></main>
<footer>TGA 2025</footer>
</body>
</html>