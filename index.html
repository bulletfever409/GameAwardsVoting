<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Game Awards Voting — Firebase Material UI</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --primary:#4FC3F7; --primary-light:#81D4FA; --primary-dark:#29B6F6;
    --surface:#FFFFFF; --surface-dark:#F3F3F3; --bg:#E0E0E0;
    --text:#212121; --text-muted:#757575; --danger:#B00020;
    --radius:12px; --shadow:0 2px 4px rgba(0,0,0,0.12), 0 4px 8px rgba(0,0,0,0.08);
  }
  *{box-sizing:border-box; font-family:'Roboto', sans-serif;}
  body{margin:0; background:var(--bg); color:var(--text);}
  header{background:var(--primary); color:#fff; padding:16px 20px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.3);}
  header h1{margin:0; font-size:20px;}
  .tabs{display:flex; gap:8px;}
  .tab{background:transparent; border:none; color:rgba(255,255,255,0.9); padding:8px 16px; border-radius:var(--radius); cursor:pointer; font-weight:500; transition:0.2s;}
  .tab.active, .tab:hover{background:rgba(255,255,255,0.2);}
  main{max-width:960px; margin:24px auto; padding:0 16px;}
  .card{background:var(--surface); border-radius:var(--radius); padding:20px; margin-bottom:20px; box-shadow:var(--shadow);}
  h2,h3{margin:0 0 12px 0; color:var(--primary-dark);}
  label{display:block; font-size:14px; color:var(--text-muted); margin-bottom:6px;}
  input[type=text], input[type=password], select{width:100%; padding:12px; border-radius:var(--radius); border:1px solid #ccc; background:var(--surface-dark); color:var(--text); margin-bottom:12px;}
  button{background:var(--primary); color:#fff; border:none; padding:12px 20px; border-radius:var(--radius); cursor:pointer; font-weight:500; transition:0.2s; box-shadow:0 2px 4px rgba(0,0,0,0.15);}
  button:hover{background:var(--primary-light);}
  button.secondary{background:#E0E0E0; color:var(--text);}
  button.small{padding:6px 12px; font-size:13px; border-radius:8px;}
  .row{display:flex; gap:16px; flex-wrap:wrap;}
  .col{flex:1; min-width:160px;}
  .notice{background:#f0f0f0; padding:12px; border-radius:var(--radius); color:var(--text-muted); margin-bottom:12px;}
  .category-box{border-radius:var(--radius); padding:12px; background:var(--surface-dark); border:1px solid #ccc; margin-bottom:12px;}
  .chip{display:inline-block; padding:6px 10px; border-radius:16px; background:#eee; margin-right:6px; margin-bottom:6px; font-size:13px;}
  .muted{color:var(--text-muted);}
  .center{text-align:center;}
  footer{max-width:960px; margin:20px auto 40px; padding:0 16px; text-align:center; font-size:13px; color:var(--text-muted);}
  .danger{background:var(--danger); color:#fff;}
</style>
</head>
<body>
<header>
  <h1>Game Awards Voting</h1>
  <div class="tabs" id="top-tabs">
    <button class="tab active" data-tab="vote">Vote</button>
    <button class="tab" data-tab="results">Results</button>
    <button class="tab" data-tab="categories">Categories</button>
    <button class="tab" data-tab="admin">Admin</button>
  </div>
</header>
<main id="app"></main>
<footer>Powered by Firebase • Material UI Edition</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD7938E45kuERRFVTKV5djhBGoqeDN29XY",
  authDomain: "game-awards-voting-d2539.firebaseapp.com",
  databaseURL: "https://game-awards-voting-d2539-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "game-awards-voting-d2539",
  storageBucket: "game-awards-voting-d2539.firebasestorage.app",
  messagingSenderId: "138398205198",
  appId: "1:138398205198:web:8ca44d0fee61f97ab7035f",
  measurementId: "G-DMH48E4BZN"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ADMIN_PASS = 'admin123';
const appEl = document.getElementById('app');
const tabsEl = document.getElementById('top-tabs');

tabsEl.addEventListener('click', ev=>{
  const btn = ev.target.closest('button.tab'); if(!btn) return;
  Array.from(tabsEl.children).forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); showPage(btn.dataset.tab);
});

function escapeHtml(s){ if(!s&&s!==0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
async function loadCategories(){ const snap=await get(ref(db,'categories')); return snap.val()||[]; }
async function saveCategories(cats){ await set(ref(db,'categories'),cats); }
async function loadVotes(){ const snap=await get(ref(db,'votes')); return snap.val()||{}; }
async function saveVote(name,vote){ await set(ref(db,'votes/'+name),vote); }
async function removeUserVotes(user){ await remove(ref(db,'votes/'+user)); }
async function clearAllVotes(){ await remove(ref(db,'votes')); }

async function showPage(page){ appEl.innerHTML=''; 
  if(page==='vote') await renderVotePage();
  else if(page==='results') await renderResultsPage();
  else if(page==='categories') await renderCategoryListPage();
  else if(page==='admin') await renderAdminPage();
}

// ---------- VOTE PAGE ----------
async function renderVotePage(){
  const categories = await loadCategories();
  const card = document.createElement('div'); card.className='card';
  card.innerHTML=`<h2>Cast Your Votes</h2><div class="muted">Enter your name and select your votes.</div>
  <div class="row"><div class="col"><label>Your Name</label><input id="voter-name" type="text" placeholder="Nickname"></div></div>
  <div id="vote-areas"></div><div class="center"><button id="submit-votes">Submit Votes</button></div>`;
  appEl.appendChild(card);
  const voteAreas = card.querySelector('#vote-areas');
  if(categories.length===0){ voteAreas.innerHTML='<div class="notice">No categories yet.</div>'; return; }
  categories.forEach(cat=>{
    const wrap=document.createElement('div'); wrap.className='category-box';
    wrap.innerHTML=`<strong>${escapeHtml(cat.name)}</strong>
      <div><label>Who will win?</label><select data-cat="${escapeHtml(cat.name)}" data-type="willWin"></select>
      <label>Who do you want to win?</label><select data-cat="${escapeHtml(cat.name)}" data-type="wantWin"></select></div>`;
    voteAreas.appendChild(wrap);
    wrap.querySelectorAll('select').forEach(s=>{
      const def=document.createElement('option'); def.value=''; def.textContent='— Select —'; s.appendChild(def);
      (cat.nominees||[]).forEach(n=>{ const opt=document.createElement('option'); opt.value=n; opt.textContent=n; s.appendChild(opt); });
    });
  });
  card.querySelector('#submit-votes').addEventListener('click', async ()=>{
    const name=card.querySelector('#voter-name').value.trim(); if(!name){ alert('Enter your name'); return; }
    const selections={}; card.querySelectorAll('select').forEach(s=>{ const c=s.dataset.cat, t=s.dataset.type; if(!selections[c]) selections[c]={}; selections[c][t]=s.value||''; });
    await saveVote(name,selections); alert('Votes saved!'); });
}

// ---------- RESULTS PAGE ----------
async function renderResultsPage(){
  const votes = await loadVotes(); const categories = await loadCategories();
  const card = document.createElement('div'); card.className='card'; card.innerHTML='<h2>All Votes</h2>'; appEl.appendChild(card);
  if(Object.keys(votes).length===0){ card.innerHTML+='<div class="muted">No votes yet.</div>'; return; }
  for(const [user,uVotes] of Object.entries(votes)){
    const block=document.createElement('div'); block.className='category-box';
    let html=`<strong>${escapeHtml(user)}</strong><br>`;
    categories.forEach(c=>{ if(uVotes[c.name]) html+=`${escapeHtml(c.name)}: Will Win: <b>${escapeHtml(uVotes[c.name].willWin||'—')}</b>, Want Win: <b>${escapeHtml(uVotes[c.name].wantWin||'—')}</b><br>`; });
    block.innerHTML=html; card.appendChild(block);
  }
}

// ---------- CATEGORIES PAGE ----------
async function renderCategoryListPage(){
  const categories = await loadCategories(); const votes = await loadVotes();
  const card = document.createElement('div'); card.className='card'; card.innerHTML='<h2>Categories</h2>'; appEl.appendChild(card);
  if(categories.length===0){ card.innerHTML+='<div class="muted">No categories yet.</div>'; return; }
  categories.forEach((c,idx)=>{
    const box=document.createElement('div'); box.className='category-box';
    box.innerHTML=`<strong>${escapeHtml(c.name)}</strong> 
      <div>${(c.nominees||[]).map(n=>`<span class="chip">${escapeHtml(n)}</span>`).join('')}</div>
      <button class="small" data-idx="${idx}">View Votes</button>`;
    card.appendChild(box);
    box.querySelector('button').addEventListener('click',()=>renderCategoryDetail(idx));
  });
}

async function renderCategoryDetail(idx){
  const categories = await loadCategories(); const votes = await loadVotes();
  const cat = categories[idx]; appEl.innerHTML=''; const card=document.createElement('div'); card.className='card';
  card.innerHTML=`<button id="back-btn" class="small">⬅ Back</button><h2>${escapeHtml(cat.name)}</h2>`; appEl.appendChild(card);
  const votesFor = {}; for(const [user,uVotes] of Object.entries(votes)){ if(uVotes[cat.name]) votesFor[user]=uVotes[cat.name]; }
  if(Object.keys(votesFor).length===0) card.innerHTML+='<div class="muted">No votes yet.</div>';
  else{ for(const [user,v] of Object.entries(votesFor)){ const div=document.createElement('div'); div.className='category-box';
    div.innerHTML=`<strong>${escapeHtml(user)}</strong><div>Will Win: <b>${escapeHtml(v.willWin||'—')}</b></div><div>Want Win: <b>${escapeHtml(v.wantWin||'—')}</b></div>`; card.appendChild(div); } }
  document.getElementById('back-btn').addEventListener('click',()=>showPage('categories'));
}

// ---------- ADMIN PAGE ----------
async function renderAdminPage(){
  const categories = await loadCategories(); const votes = await loadVotes();
  const card = document.createElement('div'); card.className='card'; card.innerHTML='<h2>Admin Panel</h2><div id="admin-root"></div>'; appEl.appendChild(card);
  const root = card.querySelector('#admin-root');
  const auth = localStorage.getItem('ga_admin_auth')==='1';
  if(!auth){
    const loginBox=document.createElement('div'); loginBox.innerHTML=`<div class="muted spaced">Enter admin password:</div>
      <div class="row"><div class="col"><input id="admin-pass" type="password" placeholder="Password"></div>
      <div><button id="admin-login">Login</button></div></div>`; root.appendChild(loginBox);
    loginBox.querySelector('#admin-login').addEventListener('click',()=>{
      if(loginBox.querySelector('#admin-pass').value===ADMIN_PASS){ localStorage.setItem('ga_admin_auth','1'); renderAdminPage(); } 
      else alert('Incorrect password'); });
    return;
  }
  // Admin UI
  const adminUI=document.createElement('div'); adminUI.innerHTML=`
    <div class="row">
      <div class="col">
        <h3>Add Category</h3>
        <label>Category name</label><input id="new-cat-name" type="text">
        <button id="add-cat">Add Category</button>
      </div>
      <div class="col">
        <h3>Manage Categories</h3>
        <select id="manage-cat-select"><option value="">Select category</option></select>
        <div id="manage-cat-area"></div>
      </div>
    </div>
    <div class="row spaced">
      <div class="col">
        <h3>Votes Management</h3>
        <select id="delete-user-select"><option value="">Select user</option></select>
        <button id="delete-user-btn" class="small danger">Delete Votes</button>
        <button id="clear-all-btn" class="danger small">Clear All Votes</button>
      </div>
      <div class="col">
        <h3>Logout</h3>
        <button id="logout-btn" class="secondary">Logout Admin</button>
      </div>
    </div>
  `; root.appendChild(adminUI);

  async function refreshCategories(){ const cats=await loadCategories(); const sel=adminUI.querySelector('#manage-cat-select'); sel.innerHTML='<option value="">Select category</option>'; cats.forEach((c,i)=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=c.name; sel.appendChild(opt); }); }
  async function refreshUsers(){ const sel=adminUI.querySelector('#delete-user-select'); sel.innerHTML='<option value="">Select user</option>'; Object.keys(await loadVotes()).forEach(u=>{ const opt=document.createElement('option'); opt.value=u; opt.textContent=u; sel.appendChild(opt); }); }

  await refreshCategories(); await refreshUsers();

  adminUI.querySelector('#add-cat').addEventListener('click', async ()=>{
    const name=adminUI.querySelector('#new-cat-name').value.trim(); if(!name) return;
    const cats=await loadCategories(); cats.push({name, nominees:[]}); await saveCategories(cats); adminUI.querySelector('#new-cat-name').value=''; await refreshCategories();
  });

  adminUI.querySelector('#delete-user-btn').addEventListener('click', async ()=>{
    const sel=adminUI.querySelector('#delete-user-select'); if(!sel.value) return; await removeUserVotes(sel.value); alert('Deleted'); await refreshUsers();
  });

  adminUI.querySelector('#clear-all-btn').addEventListener('click', async ()=>{ if(!confirm('Clear all votes?')) return; await clearAllVotes(); alert('All votes cleared'); await refreshUsers(); });

  adminUI.querySelector('#logout-btn').addEventListener('click', ()=>{ localStorage.removeItem('ga_admin_auth'); renderAdminPage(); });
}

showPage('vote');
</script>
</body>
</html>
