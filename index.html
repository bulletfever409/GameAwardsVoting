<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Game Awards Voting — Firebase Online</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#121212; --card:#1E1E1E; --surface:#1A1A1A; --border:#2A2A2A;
    --text:#E0E0E0; --text-muted:#9CA3AF;
    --primary:#4FC3F7; --primary-light:#81D4FA; --primary-dark:#29B6F6;
    --danger:#D32F2F;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, Roboto, Arial,sans-serif; background:var(--bg); margin:0; color:var(--text);}
  header{background:linear-gradient(90deg,var(--primary-dark),var(--primary)); color:#fff; padding:14px 18px; display:flex; justify-content:space-between; align-items:center;}
  header h1{margin:0;font-size:18px}
  .tabs{display:flex;gap:8px}
  .tab{background:transparent; border:0; color:rgba(255,255,255,0.85); padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:600;}
  .tab.active{background:rgba(255,255,255,0.18)}
  main{max-width:940px;margin:22px auto;padding:0 16px}
  .card{background:var(--card); border-radius:10px; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,0.45); margin-bottom:16px; border:1px solid var(--border);}
  h2,h3{margin:0 0 10px 0;color:var(--primary-light)}
  label{display:block;font-size:13px;color:var(--text-muted);margin-bottom:6px}
  input[type=text], select, input[type=password]{width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--text);}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:160px}
  button{background:var(--primary); color:#000; border:0; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:600;}
  button:hover{background:var(--primary-light)}
  button.secondary{background:#333;color:var(--text);}
  .small{padding:6px 8px;border-radius:6px;font-size:13px}
  .muted{color:var(--text-muted);font-size:13px}
  .category-box{border-radius:8px; padding:12px; background:var(--surface); border:1px solid var(--border); margin-bottom:10px;}
  .list{margin:0;padding:0;list-style:none}
  .list li{padding:8px 6px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;}
  .danger{background:var(--danger);color:#fff}
  .nominees{margin-top:8px}
  .center{text-align:center}
  .spaced{margin-top:12px}
  .chip{display:inline-block; padding:6px 10px; border-radius:16px; background:#2c2c2c; border:1px solid var(--border); margin-right:6px; margin-bottom:6px;}
  .notice{background:#2c2c2c; border:1px solid #3A3A3A; padding:10px; border-radius:8px; margin-bottom:10px; color:var(--primary-light);}
  footer{max-width:940px; margin:6px auto 40px; padding:0 16px; color:var(--text-muted); font-size:13px; text-align:center;}
  b{color:var(--primary-light)}
  @media (max-width:640px){.row{flex-direction:column}.tabs{gap:4px}}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD7938E45kuERRFVTKV5djhBGoqeDN29XY",
  authDomain: "game-awards-voting-d2539.firebaseapp.com",
  databaseURL: "https://game-awards-voting-d2539-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "game-awards-voting-d2539",
  storageBucket: "game-awards-voting-d2539.firebasestorage.app",
  messagingSenderId: "138398205198",
  appId: "1:138398205198:web:8ca44d0fee61f97ab7035f",
  measurementId: "G-DMH48E4BZN"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ADMIN_PASS = 'admin123';

const appEl = document.getElementById('app');
const tabsEl = document.getElementById('top-tabs');

tabsEl.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button.tab'); if(!btn) return;
  Array.from(tabsEl.children).forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  showPage(btn.dataset.tab);
});

function escapeHtml(s){ if(!s&&s!==0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

async function loadCategories(){ 
  const snapshot = await get(ref(db,'categories')); 
  return snapshot.val() || [];
}

async function saveCategories(cats){ await set(ref(db,'categories'), cats); }

async function loadVotes(){ const snap=await get(ref(db,'votes')); return snap.val() || {}; }

async function saveVote(name, vote){ await set(ref(db,'votes/'+name), vote); }

async function removeUserVotes(user){ await remove(ref(db,'votes/'+user)); }

async function clearAllVotes(){ await remove(ref(db,'votes')); }

async function showPage(page){
  appEl.innerHTML='';
  if(page==='vote') await renderVotePage();
  else if(page==='results') await renderResultsPage();
  else if(page==='categories') await renderCategoryListPage();
  else if(page==='admin') await renderAdminPage();
}

async function renderVotePage(){
  const categories = await loadCategories();
  const card = document.createElement('div'); card.className='card';
  card.innerHTML=`
    <h2>Cast Your Votes</h2>
    <div class="muted spaced">Enter your name, choose from the dropdowns, then press Submit.</div>
    <div class="row spaced">
      <div class="col"><label>Your name</label><input id="voter-name" type="text" placeholder="Full name or nickname"></div>
    </div>
    <div id="vote-areas"></div>
    <div class="spaced center"><button id="submit-votes">Submit Votes</button></div>
  `;
  appEl.appendChild(card);
  const voteAreas = card.querySelector('#vote-areas');
  if(categories.length===0){ voteAreas.innerHTML='<div class="notice">No categories yet.</div>'; return; }
  categories.forEach(cat=>{
    const wrap=document.createElement('div'); wrap.className='category-box';
    wrap.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><strong>${escapeHtml(cat.name)}</strong></div>
    <div class="nominees">
      <label><b>Who will win?</b></label><select data-cat="${escapeHtml(cat.name)}" data-type="willWin"></select>
      <label style="margin-top:8px"><b>Who do you want to win?</b></label><select data-cat="${escapeHtml(cat.name)}" data-type="wantWin"></select>
    </div>`;
    voteAreas.appendChild(wrap);
    wrap.querySelectorAll('select').forEach(s=>{
      const def=document.createElement('option'); def.value=''; def.textContent='— Select —'; s.appendChild(def);
      (cat.nominees||[]).forEach(n=>{
        const opt=document.createElement('option'); opt.value=n; opt.textContent=n; s.appendChild(opt);
      });
    });
  });
  card.querySelector('#submit-votes').addEventListener('click', async ()=>{
    const name=card.querySelector('#voter-name').value.trim();
    if(!name){ alert('Enter your name'); return; }
    const selections={};
    card.querySelectorAll('select').forEach(s=>{
      const c=s.getAttribute('data-cat'), t=s.getAttribute('data-type');
      if(!selections[c]) selections[c]={};
      selections[c][t]=s.value||'';
    });
    await saveVote(name,selections); alert('Votes saved online.');
  });
}

// Results, Categories, Category Detail functions remain the same as previous version
// For brevity, you can keep the existing implementations for renderResultsPage, renderCategoryListPage, renderCategoryDetail

async function renderAdminPage(){
  const card=document.createElement('div'); card.className='card'; card.innerHTML='<h2>Admin Panel</h2><div id="admin-root"></div>'; appEl.appendChild(card);
  const root=card.querySelector('#admin-root');
  const auth = localStorage.getItem('ga_admin_auth')==='1';
  if(!auth){
    const loginBox=document.createElement('div'); loginBox.innerHTML='<div class="muted spaced">Enter admin password:</div><div class="row"><div class="col"><input id="admin-pass" type="password"></div><div><button id="admin-login">Login</button></div></div>'; root.appendChild(loginBox);
    loginBox.querySelector('#admin-login').addEventListener('click',()=>{
      const val=loginBox.querySelector('#admin-pass').value;
      if(val===ADMIN_PASS){ localStorage.setItem('ga_admin_auth','1'); renderAdminPage(); } else alert('Incorrect password');
    });
    return;
  }

  const adminUI=document.createElement('div'); adminUI.innerHTML=`
    <div class="row">
      <div class="col">
        <h3>Add Category</h3>
        <label>Category name</label>
        <input id="new-cat-name" type="text">
        <div class="spaced"><button id="add-cat">Add Category</button></div>
      </div>
      <div class="col">
        <h3>Manage Categories</h3>
        <label>Select category</label>
        <select id="manage-cat-select"></select>
        <div class="spaced" id="manage-cat-area"></div>
      </div>
    </div>
    <div class="row spaced">
      <div class="col">
        <h3>Votes Management</h3>
        <label>Delete user votes</label>
        <select id="delete-user-select"></select>
        <div class="spaced"><button id="delete-user-btn" class="small danger">Delete Votes</button></div>
        <div class="spaced"><label>Clear all votes</label><button id="clear-all-btn" class="danger small">Clear All</button></div>
      </div>
      <div class="col">
        <h3>Admin Logout</h3>
        <button id="logout-btn" class="secondary">Logout Admin</button>
      </div>
    </div>
  `;
  root.appendChild(adminUI);

  async function refreshManageSelect(){
    const sel = adminUI.querySelector('#manage-cat-select');
    sel.innerHTML=''; const empty = document.createElement('option'); empty.value=''; empty.textContent='Select category'; sel.appendChild(empty);
    const categories = await loadCategories();
    categories.forEach((c,i)=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=c.name; sel.appendChild(opt); });
    if(sel.value) renderManageArea(sel.value);
  }

  async function renderManageArea(idx){
    if(idx===''){ adminUI.querySelector('#manage-cat-area').innerHTML=''; return; }
    idx=parseInt(idx);
    const categories = await loadCategories();
    const cat = categories[idx];
    const area = adminUI.querySelector('#manage-cat-area');
    area.innerHTML=`<label>Add nominee</label><div class="row"><div class="col"><input id="new-nom"></div><div><button id="add-nom">Add</button></div></div>
      <div class="spaced"><strong>Nominees</strong></div>
      <ul class="list" id="nom-list"></ul>
      <div class="spaced"><button id="delete-cat" class="danger">Delete Category & Votes</button></div>`;
    const nomList=area.querySelector('#nom-list');
    (cat.nominees||[]).forEach((n,i)=>{
      const li=document.createElement('li'); li.innerHTML=`<span>${escapeHtml(n)}</span><div><button class="small" data-idx="${i}" data-cat="${idx}">Delete</button></div>`;
      nomList.appendChild(li);
    });
    area.querySelector('#add-nom').addEventListener('click', async ()=>{
      const val=area.querySelector('#new-nom').value.trim(); if(!val){ alert('Enter name'); return; }
      cat.nominees=cat.nominees||[]; cat.nominees.push(val);
      const categories = await loadCategories(); categories[idx]=cat; await saveCategories(categories); renderManageArea(idx);
    });
    nomList.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const nidx=parseInt(b.dataset.idx), cidx=parseInt(b.dataset.cat);
        const categories = await loadCategories(); categories[cidx].nominees.splice(nidx,1); await saveCategories(categories); renderManageArea(cidx);
      });
    });
    area.querySelector('#delete-cat').addEventListener('click', async ()=>{
      if(!confirm('Delete category and all votes?')) return;
      const categories = await loadCategories(); const catName=categories[idx].name; categories.splice(idx,1); await saveCategories(categories);
      const votes = await loadVotes(); for(const u in votes){ if(votes[u]&&votes[u][catName]) delete votes[u][catName]; await set(ref(db,'votes'),votes);}
      alert('Category and votes deleted'); refreshManageSelect();
    });
  }

  adminUI.querySelector('#add-cat').addEventListener('click', async ()=>{
    const name=adminUI.querySelector('#new-cat-name').value.trim(); if(!name){ alert('Enter category name'); return; }
    const categories = await loadCategories(); categories.push({name, nominees:[]}); await saveCategories(categories); refreshManageSelect(); adminUI.querySelector('#new-cat-name').value='';
  });

  adminUI.querySelector('#manage-cat-select').addEventListener('change', ()=>renderManageArea(adminUI.querySelector('#manage-cat-select').value));

  // Votes deletion
  async function refreshDeleteUserSelect(){
    const sel=adminUI.querySelector('#delete-user-select'); sel.innerHTML=''; const empty=document.createElement('option'); empty.value=''; empty.textContent='Select user'; sel.appendChild(empty);
    const votes = await loadVotes();
    Object.keys(votes).forEach(u=>{ const opt=document.createElement('option'); opt.value=u; opt.textContent=u; sel.appendChild(opt); });
  }
  refreshDeleteUserSelect();
  adminUI.querySelector('#delete-user-btn').addEventListener('click', async ()=>{
    const sel=adminUI.querySelector('#delete-user-select'); if(!sel.value) return; if(!confirm('Delete votes for '+sel.value+'?')) return;
    await removeUserVotes(sel.value); alert('Deleted'); refreshDeleteUserSelect();
  });
  adminUI.querySelector('#clear-all-btn').addEventListener('click', async ()=>{
    if(!confirm('Delete ALL votes?')) return; await clearAllVotes(); alert('Deleted all votes'); refreshDeleteUserSelect();
  });
  adminUI.querySelector('#logout-btn').addEventListener('click', ()=>{
    localStorage.removeItem('ga_admin_auth'); renderAdminPage();
  });

  refreshManageSelect();
}

showPage('vote');
</script>
</head>
<body>
<header>
  <h1>Game Awards Voting</h1>
  <div class="tabs" id="top-tabs">
    <button class="tab active" data-tab="vote">Vote</button>
    <button class="tab" data-tab="results">Results</button>
    <button class="tab" data-tab="categories">Categories</button>
    <button class="tab" data-tab="admin">Admin</button>
  </div>
</header>
<main id="app"></main>
<footer>Powered by Firebase • Dark Mode Edition</footer>
</body>
</html>
